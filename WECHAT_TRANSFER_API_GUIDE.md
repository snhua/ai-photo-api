# 微信商家转账 API 配置指南

## 概述

本文档介绍如何配置和使用微信商家转账 API，实现用户提现到微信零钱功能。

## 1. 微信商家转账产品介绍

根据[微信支付官方文档](https://pay.weixin.qq.com/doc/v3/merchant/4012711988)，商家转账目前仅支持微信商户向用户微信零钱转账，为商户提供免费、安全的转账服务。

### 1.1 产品特色

- **提升转账效率、安全性**：支持用户点击收款后即时入账，提供免费的安全医生服务
- **用户明确收款方式**：用户主动选择入账微信，避免用户对账不清引发客诉
- **闭环处理异常**：用户微信账户存在异常时，可闭环在微信内解脱、完成收款

### 1.2 转账场景

支持以下转账场景：

- 现金营销
- 现金奖励
- 企业赔付
- 商家赔付
- 佣金报酬
- 报销款
- 企业补贴
- 开工利是
- 采购货款
- 二手回收
- 公益补助
- 行政补贴
- 行政奖励
- 保险理赔

## 2. 配置要求

### 2.1 商户资质要求

1. **开通商家转账权限**

   - 登录微信商户平台
   - 进入产品中心 → 商家转账
   - 申请开通产品权限

2. **配置 IP 白名单**

   - 设置接口安全 IP
   - 确保服务器 IP 在允许列表中

3. **配置证书**
   - 商户 API 证书
   - 商户私钥
   - 证书序列号

### 2.2 配置文件

在 `application.yml` 中添加以下配置：

```yaml
wechat:
  pay:
    appId: your_app_id
    mchId: your_mch_id
    apiV3Key: your_api_v3_key
    serialNo: your_serial_no
    privateKeyPath: /path/to/your/private_key.pem
```

## 3. API 接口实现

### 3.1 发起转账

**接口地址**：`POST /v3/transfer/batches`

**请求示例**：

```json
{
  "appid": "wx8888888888888888",
  "out_batch_no": "WD202312011234567890",
  "batch_name": "提现到微信零钱",
  "batch_remark": "AI绘画师提现",
  "transfer_detail_list": [
    {
      "out_detail_no": "WD202312011234567890_detail",
      "transfer_amount": 1000,
      "transfer_remark": "提现到微信零钱",
      "openid": "user_openid"
    }
  ],
  "transfer_scene_id": {
    "id": "COMMISSION"
  },
  "background_info": {
    "type": "岗位类型",
    "content": "AI绘画师提现"
  }
}
```

### 3.2 查询转账

**接口地址**：`GET /v3/transfer/batches/out-batch-no/{out_batch_no}`

## 4. 状态说明

### 4.1 批次状态

- `ACCEPTED`：已受理
- `PROCESSING`：处理中
- `FINISHED`：已完成
- `CLOSED`：已关闭

### 4.2 明细状态

- `PROCESSING`：处理中
- `SUCCESS`：成功
- `FAILED`：失败

## 5. 业务逻辑

### 5.1 提现流程

1. **申请阶段**

   - 验证用户可提现金额
   - 检查提现金额限制
   - 创建提现申请记录

2. **处理阶段**

   - 调用微信商家转账 API
   - 更新提现状态
   - 记录交易流水

3. **完成阶段**
   - 提现成功：更新状态为 success
   - 提现失败：更新状态为 failed，退还可提现金额

### 5.2 金额限制

- **单笔最大金额**：2000 元
- **每日最大金额**：10000 元
- **最小金额**：0.3 元
- **超过 2000 元必须实名校验**

## 6. 测试指南

### 6.1 测试脚本

使用提供的测试脚本：

```bash
./test_wechat_transfer_api.sh
```

### 6.2 测试用例

1. **正常提现**

   - 申请提现
   - 处理提现
   - 查询状态
   - 验证结果

2. **异常情况**
   - 金额不足
   - 金额超限
   - 网络异常
   - 签名错误

## 7. 部署注意事项

### 7.1 生产环境

1. **证书安全**：妥善保管证书文件
2. **IP 白名单**：配置生产环境 IP
3. **监控告警**：设置转账失败告警
4. **日志记录**：记录详细的转账日志

### 7.2 性能优化

1. **连接池**：使用 HTTP 连接池
2. **异步处理**：异步处理转账请求
3. **缓存机制**：缓存用户信息
4. **限流控制**：控制 API 调用频率

## 8. 常见问题

### 8.1 配置问题

**Q: 证书路径配置错误**
A: 检查证书文件路径是否正确，确保文件存在且有读取权限

**Q: 商户号配置错误**
A: 确认商户号是否正确，检查商户资质是否满足要求

### 8.2 接口问题

**Q: 签名验证失败**
A: 检查签名算法和参数是否正确，确认私钥文件有效

**Q: 金额格式错误**
A: 金额单位为分，需要将元转换为分

## 9. 参考文档

- [微信支付商家转账 API 文档](https://pay.weixin.qq.com/doc/v3/merchant/4012711988)
- [微信支付 API V3 签名算法](https://pay.weixin.qq.com/docs/merchant/development/interface-rules/wechatpay-signature-algorithm-v3.html)
